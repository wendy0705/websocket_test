<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>聊天室測試</title>
    <style>
        body {
            font-family: Arial, sans-serif;
        }
        #chat-box {
            width: 100%;
            height: 300px;
            border: 1px solid #ccc;
            padding: 10px;
            overflow-y: scroll;
            margin-bottom: 10px;
        }
        #messageInput {
            width: 80%;
        }
        #sendButton {
            width: 18%;
        }
    </style>
</head>
<body>

<h1>Chat Invitation Test</h1>

<!-- 模擬邀請者 ID 和被邀請者 ID -->
<label for="inviterId">Inviter ID:</label>
<input type="text" id="inviterId" placeholder="Enter inviter ID">
<br>

<label for="inviteeId">Invitee ID:</label>
<input type="text" id="inviteeId" placeholder="Enter invitee ID">
<br>

<!-- 發送邀請按鈕 -->
<button id="sendInviteBtn">Send Chat Invitation</button>
<div id="invitation"></div>

<!-- 顯示結果的區域 -->
<p id="result"></p>

<!-- WebSocket 聊天區域 -->
<h2>Chat Room</h2>
<input type="text" id="messageInput" placeholder="Enter message">
<button id="sendMessageBtn">Send Message</button>
<div id="messages"></div>

<script>
    document.getElementById('sendInviteBtn').addEventListener('click', function() {
        const inviterId = document.getElementById('inviterId').value;
        const inviteeId = document.getElementById('inviteeId').value;

        // 發送邀請請求到後端
        fetch('/chat/invite', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                inviter_id: inviterId,
                invitee_id: inviteeId
            })
        })
            .then(response => response.json())
            .then(data => {
                console.log(JSON.stringify(data));
                document.getElementById('result').innerText = 'Invitation sent: ' + JSON.stringify(data);

                // 獲取 sorted IDs，然後建立 WebSocket 連接
                const sortedIds = [inviterId, inviteeId].sort();
                const roomName = `${sortedIds[0]}_${sortedIds[1]}`;

                const socket = new WebSocket(`ws://localhost:8080/chat?userId=${inviterId}&roomName=${roomName}`);

                // 處理 WebSocket 事件
                socket.onopen = function() {
                    console.log('WebSocket connection established');
                    document.getElementById('messages').innerText = 'Connected to chat room: ' + roomName;
                };

                socket.onmessage = function(event) {
                    const messageDiv = document.createElement('div');
                    messageDiv.innerText = 'Received: ' + event.data;
                    document.getElementById('messages').appendChild(messageDiv);
                };

                socket.onerror = function(error) {
                    console.error('WebSocket error:', error);
                };

                // 發送訊息
                document.getElementById('sendMessageBtn').addEventListener('click', function() {
                    const message = document.getElementById('messageInput').value;
                    socket.send(message);
                    const messageDiv = document.createElement('div');
                    messageDiv.innerText = 'Sent: ' + message;
                    document.getElementById('messages').appendChild(messageDiv);
                    document.getElementById('messageInput').value = '';
                });
            })
            .catch(error => {
                document.getElementById('result').innerText = 'Error: ' + error;
                console.error('Error sending invitation:', error);
            });
    });
</script>

</body>
</html>
